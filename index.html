<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Aplikasi Absensi Online dengan Geolocation dan Selfie Verification">
    <meta name="theme-color" content="#2563eb">
    <title>Sistem Absensi Pro</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“‹</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, MapPin, User, LogOut, FileText, 
            Users, Bell, Calendar, CheckCircle, XCircle, 
            Menu, Download, Upload, Clock, Home, AlertCircle, Coffee, Trash2,
            Database, Save, Mail, HardDrive, Filter, Search, ClipboardCheck, Plus, RefreshCw, UserPlus, ArrowLeft, Key, Eye, EyeOff, Lock, Activity, Cloud, Link2
        } from 'lucide-react';

        /**
         * INITIAL DATA
         */
        const INITIAL_USERS = [
            { id: 1, name: 'Administrator', email: 'marliantoskyscraper@gmail.com', role: 'admin', password: 'abc12345', department: 'Management', position: 'Head Admin', location: 'PALANGKARAYA', phone: '-' },
            { id: 2, name: 'Marlianto', email: 'marlianto@kantor.com', role: 'employee', password: 'marli123', department: 'PUPR', position: 'Staff', location: 'KOBAR', phone: '-' }
        ];

        const INITIAL_ANNOUNCEMENTS = [
            { id: 1, title: 'Selamat Datang', content: 'Selamat datang di sistem absensi digital baru.', date: new Date().toISOString().split('T')[0] }
        ];

        const INITIAL_LOGS = [];
        const INITIAL_PERMITS = [];
        const INITIAL_CONFIG = { googleScriptUrl: '' }; // Config untuk URL Google Script

        const LOCATIONS = ['KOBAR', 'LAMANDAU', 'SUKAMARA', 'PALANGKARAYA'];

        const formatDate = (dateString) => {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        };

        const formatSimpleDate = (dateString) => {
            return new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        };

        // --- KOMPONEN UI DASAR ---

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, icon: Icon }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                secondary: "bg-gray-100 text-gray-700 hover:bg-gray-200",
                danger: "bg-red-500 text-white hover:bg-red-600",
                success: "bg-green-600 text-white hover:bg-green-700",
                warning: "bg-yellow-500 text-white hover:bg-yellow-600",
                outline: "border border-gray-300 text-gray-700 hover:bg-gray-50"
            };

            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {Icon && <Icon size={18} />} {children}
                </button>
            );
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-4 ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, type = 'info' }) => {
            const styles = {
                info: 'bg-blue-100 text-blue-800', success: 'bg-green-100 text-green-800', warning: 'bg-yellow-100 text-yellow-800', danger: 'bg-red-100 text-red-800', gray: 'bg-gray-100 text-gray-800'
            };
            return <span className={`px-2 py-1 rounded-full text-xs font-semibold ${styles[type] || styles.info}`}>{children}</span>;
        };

        // --- HALAMAN UTAMA ---

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const lastSyncToken = useRef(localStorage.getItem('app_sync_token') || '0');
            
            // --- STATE MANAGEMENT ---
            const [users, setUsers] = useState(() => {
                try {
                    const saved = localStorage.getItem('app_users');
                    return saved ? JSON.parse(saved) : INITIAL_USERS;
                } catch { return INITIAL_USERS; }
            });
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('app_logs')) || INITIAL_LOGS);
            const [announcements, setAnnouncements] = useState(() => JSON.parse(localStorage.getItem('app_announcements')) || INITIAL_ANNOUNCEMENTS);
            const [permits, setPermits] = useState(() => JSON.parse(localStorage.getItem('app_permits')) || INITIAL_PERMITS);
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('app_config')) || INITIAL_CONFIG);

            // --- FUNGSI UPDATE DATA & SYNC ---
            const updateData = (key, data) => {
                const token = Date.now().toString();
                if (key === 'users') setUsers(data);
                if (key === 'logs') setLogs(data);
                if (key === 'announcements') setAnnouncements(data);
                if (key === 'permits') setPermits(data);
                if (key === 'config') setConfig(data);
                
                localStorage.setItem(`app_${key}`, JSON.stringify(data));
                localStorage.setItem('app_sync_token', token);
            };

            // --- CLOUD SYNC FUNCTION (GOOGLE SHEETS) ---
            const pushToGoogleSheets = async (payload) => {
                if (!config.googleScriptUrl) return; // Tidak ada URL, skip
                
                try {
                    // Gunakan mode no-cors karena Google Script Web App berada di domain berbeda
                    await fetch(config.googleScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    console.log("Data sent to Google Sheets");
                } catch (error) {
                    console.error("Gagal kirim ke Google Sheets:", error);
                }
            };

            // --- REAL-TIME SYNC ENGINE ---
            useEffect(() => {
                // Migrasi Admin
                const currentUsers = JSON.parse(localStorage.getItem('app_users')) || [];
                const admin = currentUsers.find(u => u.id === 1);
                const adminCode = INITIAL_USERS[0];
                if (!admin || admin.email !== adminCode.email || admin.password !== adminCode.password) {
                    const updatedUsers = [adminCode, ...currentUsers.filter(u => u.id !== 1)];
                    if (!updatedUsers.find(u => u.id === 2)) updatedUsers.push(INITIAL_USERS[1]);
                    updateData('users', updatedUsers);
                }

                // Polling Check
                const checkUpdates = () => {
                    const currentToken = localStorage.getItem('app_sync_token');
                    if (currentToken && currentToken !== lastSyncToken.current) {
                        lastSyncToken.current = currentToken;
                        setUsers(JSON.parse(localStorage.getItem('app_users') || '[]'));
                        setLogs(JSON.parse(localStorage.getItem('app_logs') || '[]'));
                        setAnnouncements(JSON.parse(localStorage.getItem('app_announcements') || '[]'));
                        setPermits(JSON.parse(localStorage.getItem('app_permits') || '[]'));
                        setConfig(JSON.parse(localStorage.getItem('app_config') || JSON.stringify(INITIAL_CONFIG)));
                    }
                };

                window.addEventListener('storage', (e) => { if (e.key === 'app_sync_token') checkUpdates(); });
                const interval = setInterval(checkUpdates, 1000);
                return () => clearInterval(interval);
            }, []);
            
            // --- AUTH LOGIC ---
            const [authView, setAuthView] = useState('login'); 
            const [loginData, setLoginData] = useState({ email: '', password: '' });
            const [registerData, setRegisterData] = useState({ name: '', email: '', password: '', department: '', position: '', location: '' });
            const [forgotEmail, setForgotEmail] = useState('');
            const [authError, setAuthError] = useState('');
            const [authSuccess, setAuthSuccess] = useState('');

            useEffect(() => {
                const savedUser = sessionStorage.getItem('currentUser');
                if (savedUser) setCurrentUser(JSON.parse(savedUser));
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => u.email.toLowerCase() === loginData.email.toLowerCase() && u.password === loginData.password);
                if (user) {
                    setCurrentUser(user);
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    setAuthError('');
                } else {
                    setAuthError('Email atau password salah!');
                }
            };

            const handleRegister = (e) => {
                e.preventDefault();
                if (users.find(u => u.email.toLowerCase() === registerData.email.toLowerCase())) {
                    setAuthError('Email sudah terdaftar!'); return;
                }
                const newUser = { id: Date.now(), name: registerData.name, email: registerData.email, password: registerData.password, department: registerData.department, position: registerData.position, location: registerData.location, role: 'employee', phone: '-' };
                
                updateData('users', [...users, newUser]);
                
                // Kirim data registrasi ke Cloud (opsional)
                pushToGoogleSheets({ name: newUser.name, type: 'Registrasi Baru', status: 'User', location: newUser.location, info: newUser.email });

                setAuthError('');
                setLoginData({ email: registerData.email, password: registerData.password });
                alert('Pendaftaran Berhasil!');
                setAuthView('login'); 
                setRegisterData({ name: '', email: '', password: '', department: '', position: '', location: '' });
            };

            const handleForgotPassword = (e) => {
                e.preventDefault();
                const user = users.find(u => u.email.toLowerCase() === forgotEmail.toLowerCase());
                if (user) {
                    setAuthError('');
                    setAuthSuccess(`Akun ditemukan: ${user.name}. Hubungi Admin untuk reset.`);
                } else {
                    setAuthSuccess('');
                    setAuthError('Email tidak ditemukan.');
                }
            };

            const handleLogout = () => {
                setCurrentUser(null);
                sessionStorage.removeItem('currentUser');
                setLoginData({ email: '', password: '' });
                setAuthView('login');
                setAuthSuccess('');
                setAuthError('');
            };

            const handleResetSystem = () => {
                if(confirm("PERINGATAN: Reset sistem akan menghapus semua data. Lanjutkan?")) {
                    localStorage.clear(); sessionStorage.clear(); window.location.reload();
                }
            }

            const manualSync = () => {
                setLogs(JSON.parse(localStorage.getItem('app_logs') || '[]'));
                setUsers(JSON.parse(localStorage.getItem('app_users') || '[]'));
                setPermits(JSON.parse(localStorage.getItem('app_permits') || '[]'));
                alert("Data disinkronkan!");
            };

            if (!currentUser) {
                return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="bg-blue-600 p-8 text-center">
                            <div className="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm">
                                <CheckCircle size={32} className="text-white" />
                            </div>
                            <h1 className="text-2xl font-bold text-white">E-Absensi Pro</h1>
                            <p className="text-blue-100 text-sm">Sistem Absensi Terintegrasi</p>
                        </div>
                        <div className="p-8">
                            {authError && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2 mb-4"><AlertCircle size={16} /> <span>{authError}</span></div>}
                            {authSuccess && <div className="bg-green-50 text-green-600 p-3 rounded-lg text-sm flex items-center gap-2 mb-4"><CheckCircle size={16} /> <span>{authSuccess}</span></div>}

                            {authView === 'login' && (
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <h2 className="text-lg font-bold text-gray-800 text-center">Login Masuk</h2>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" className="w-full px-4 py-2 border border-gray-300 rounded-lg" value={loginData.email} onChange={(e) => setLoginData({...loginData, email: e.target.value})} required /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" className="w-full px-4 py-2 border border-gray-300 rounded-lg" value={loginData.password} onChange={(e) => setLoginData({...loginData, password: e.target.value})} required /></div>
                                    <div className="flex justify-end"><button type="button" onClick={() => { setAuthView('forgot'); setAuthError(''); }} className="text-xs text-blue-600 hover:underline">Lupa Password?</button></div>
                                    <Button className="w-full mt-2">Masuk Sistem</Button>
                                    <div className="text-center mt-4"><p className="text-sm text-gray-600">Belum punya akun?</p><button type="button" onClick={() => { setAuthView('register'); setAuthError(''); }} className="text-blue-600 font-bold hover:underline text-sm mt-1 flex items-center justify-center gap-1 mx-auto"><UserPlus size={14}/> Daftar Karyawan Baru</button></div>
                                </form>
                            )}
                            {authView === 'register' && (
                                <form onSubmit={handleRegister} className="space-y-3">
                                    <div className="flex items-center gap-2 mb-2"><button type="button" onClick={() => setAuthView('login')} className="text-gray-500 hover:text-gray-700"><ArrowLeft size={20}/></button><h2 className="text-lg font-bold text-gray-800">Pendaftaran Baru</h2></div>
                                    <input className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Nama Lengkap" value={registerData.name} onChange={(e) => setRegisterData({...registerData, name: e.target.value})} required />
                                    <input type="email" className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Email Aktif" value={registerData.email} onChange={(e) => setRegisterData({...registerData, email: e.target.value})} required />
                                    <input type="password" className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Password" value={registerData.password} onChange={(e) => setRegisterData({...registerData, password: e.target.value})} required />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Divisi (Cth: PUPR)" value={registerData.department} onChange={(e) => setRegisterData({...registerData, department: e.target.value})} required />
                                        <input className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Jabatan" value={registerData.position} onChange={(e) => setRegisterData({...registerData, position: e.target.value})} required />
                                    </div>
                                    <select className="w-full px-3 py-2 border rounded-lg text-sm bg-white" value={registerData.location} onChange={(e) => setRegisterData({...registerData, location: e.target.value})} required >
                                        <option value="">Pilih Lokasi Penempatan</option>
                                        {LOCATIONS.map(loc => (<option key={loc} value={loc}>{loc}</option>))}
                                    </select>
                                    <Button className="w-full mt-4" variant="success">Daftar & Sinkronisasi</Button>
                                </form>
                            )}
                            {authView === 'forgot' && (
                                <form onSubmit={handleForgotPassword} className="space-y-4">
                                    <div className="flex items-center gap-2 mb-2"><button type="button" onClick={() => { setAuthView('login'); setAuthError(''); }} className="text-gray-500 hover:text-gray-700"><ArrowLeft size={20}/></button><h2 className="text-lg font-bold text-gray-800">Lupa Password</h2></div>
                                    <p className="text-sm text-gray-600">Masukkan email verifikasi.</p>
                                    <input type="email" className="w-full px-4 py-2 border border-gray-300 rounded-lg" value={forgotEmail} onChange={(e) => setForgotEmail(e.target.value)} required />
                                    <Button className="w-full" variant="warning">Cek Akun</Button>
                                </form>
                            )}
                        </div>
                    </div>
                </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col">
                <header className="bg-white shadow-sm sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                    <div className="flex items-center gap-2"><div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">A</div><h1 className="font-bold text-gray-800 hidden sm:block">E-Absensi</h1></div>
                    <div className="flex items-center gap-4"><div className="text-right hidden sm:block"><p className="text-sm font-medium text-gray-900">{currentUser.name}</p><p className="text-xs text-gray-500 capitalize">{currentUser.role}</p></div><button onClick={handleLogout} className="p-2 hover:bg-gray-100 rounded-full text-red-500"><LogOut size={20} /></button></div>
                    </div>
                </header>
                <main className="flex-1 max-w-7xl w-full mx-auto p-4">
                    {currentUser.role === 'admin' ? (
                    <AdminDashboard users={users} logs={logs} announcements={announcements} permits={permits} config={config} updateData={updateData} handleResetSystem={handleResetSystem} manualSync={manualSync} />
                    ) : (
                    <EmployeeDashboard user={currentUser} logs={logs} announcements={announcements} permits={permits} updateData={updateData} pushToGoogleSheets={pushToGoogleSheets} />
                    )}
                </main>
                </div>
            );
        }

        // --- DASHBOARD ADMIN ---

        function AdminDashboard({ users, logs, announcements, permits, config, updateData, handleResetSystem, manualSync }) {
            const [view, setView] = useState('overview'); 
            const [newUser, setNewUser] = useState({ name: '', email: '', department: '', position: '', location: '', role: 'employee' });
            const [newConfig, setNewConfig] = useState(config.googleScriptUrl);
            const [startDate, setStartDate] = useState(''); const [endDate, setEndDate] = useState(''); const [showPassword, setShowPassword] = useState({}); 

            const filteredLogs = logs.filter(log => {
                if (!startDate && !endDate) return true;
                const logDate = new Date(log.timestamp); logDate.setHours(0,0,0,0);
                const start = startDate ? new Date(startDate) : new Date('2000-01-01'); start.setHours(0,0,0,0);
                const end = endDate ? new Date(endDate) : new Date(); end.setHours(23,59,59,999);
                return logDate >= start && logDate <= end;
            });

            const togglePassword = (id) => setShowPassword(prev => ({ ...prev, [id]: !prev[id] }));
            const handlePermitAction = (id, status) => { const updatedPermits = permits.map(p => p.id === id ? { ...p, status: status } : p); updateData('permits', updatedPermits); alert(`Pengajuan berhasil di-${status === 'Approved' ? 'setujui' : 'tolak'}.`); };
            const handleExportCSV = () => { let csvContent = "data:text/csv;charset=utf-8,ID,Nama,Divisi,Jabatan,Lokasi_Kerja,Tipe,Waktu,Lokasi_Absen\n"; filteredLogs.forEach(row => { const user = users.find(u => u.id === row.userId) || {}; csvContent += `${row.id},"${row.name}","${user.department || '-'}","${user.position || '-'}","${user.location || '-'}",${row.type},${row.timestamp},"${row.location}"\n`; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `Laporan_Absensi.csv`); document.body.appendChild(link); link.click(); };
            const handleBackupJSON = () => { const backupData = { users, logs, announcements, permits, config, exportDate: new Date().toISOString() }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const link = document.createElement("a"); link.setAttribute("href", dataStr); link.setAttribute("download", `BACKUP_FULL.json`); document.body.appendChild(link); link.click(); };
            const handleRestoreJSON = (event) => { const fileReader = new FileReader(); fileReader.readAsText(event.target.files[0], "UTF-8"); fileReader.onload = e => { try { const parsedData = JSON.parse(e.target.result); if(parsedData.users) { if(confirm("Restore data?")) { updateData('users', parsedData.users); updateData('logs', parsedData.logs || []); updateData('announcements', parsedData.announcements || []); updateData('permits', parsedData.permits || []); updateData('config', parsedData.config || {googleScriptUrl:''}); alert("Restore berhasil!"); window.location.reload(); } } } catch (err) { alert("Gagal membaca file."); } }; };
            const handleEmailBackup = () => { handleExportCSV(); const emailTo = "karsasentana@gmail.com"; const subject = `Laporan Database Absensi - ${new Date().toLocaleDateString()}`; const body = `Halo Admin,\n\nTerlampir laporan absensi terbaru.\n\nTerima kasih.`; window.location.href = `mailto:${emailTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`; };
            const handleAddUser = (e) => { e.preventDefault(); const newUserObj = { ...newUser, id: Date.now(), password: 'user' }; updateData('users', [...users, newUserObj]); setNewUser({ name: '', email: '', department: '', position: '', location: '', role: 'employee' }); alert('Karyawan berhasil ditambahkan!'); };
            const handleAddAnnouncement = (text) => { const newAnn = { id: Date.now(), title: "Info Admin", content: text, date: new Date().toISOString().split('T')[0] }; updateData('announcements', [newAnn, ...announcements]); };
            
            const handleSaveConfig = () => {
                updateData('config', { googleScriptUrl: newConfig });
                alert("URL Google Sheets berhasil disimpan!");
            };

            return (
                <div className="space-y-6">
                <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-2 rounded-lg flex items-center justify-between text-sm shadow-sm">
                    <div className="flex items-center gap-2"><Activity size={16} className="animate-pulse" /><span className="font-semibold">Live Sync:</span> {config.googleScriptUrl ? "Terhubung ke Google Sheets" : "Lokal Storage Aktif"}</div>
                    <div className="flex items-center gap-4"><span className="text-xs text-green-600">{new Date().toLocaleTimeString()}</span><button onClick={manualSync} className="text-xs bg-white border border-green-300 px-2 py-1 rounded hover:bg-green-100 flex items-center gap-1"><RefreshCw size={12}/> Refresh</button></div>
                </div>

                <div className="flex overflow-x-auto gap-2 pb-2">
                    {[{ id: 'overview', label: 'Dashboard', icon: Home }, { id: 'employees', label: 'Karyawan', icon: Users }, { id: 'approvals', label: `Persetujuan`, icon: ClipboardCheck }, { id: 'reports', label: 'Laporan', icon: FileText }, { id: 'announcements', label: 'Info', icon: Bell }, { id: 'database', label: 'Database', icon: Database }].map((tab) => (
                    <button key={tab.id} onClick={() => setView(tab.id)} className={`flex items-center gap-2 px-4 py-2 rounded-lg whitespace-nowrap transition ${view === tab.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50'}`}> <tab.icon size={18} /> {tab.label} </button> ))}
                </div>

                {view === 'overview' && ( <div className="grid grid-cols-1 md:grid-cols-3 gap-4"> <Card className="bg-blue-600 text-white border-none"><h3>Total Karyawan</h3><p className="text-3xl font-bold mt-2">{users.length - 1}</p></Card> <Card className="bg-green-600 text-white border-none"><h3>Hadir Hari Ini</h3><p className="text-3xl font-bold mt-2">{new Set(logs.filter(l => new Date(l.timestamp).toDateString() === new Date().toDateString()).map(l => l.userId)).size}</p></Card> <Card className="bg-orange-600 text-white border-none"><h3>Menunggu Persetujuan</h3><p className="text-3xl font-bold mt-2">{permits.filter(p => p.status === 'Pending').length}</p></Card> </div> )}
                {view === 'employees' && ( <div className="grid grid-cols-1 lg:grid-cols-3 gap-6"> <div className="lg:col-span-2"> <div className="bg-white rounded-xl shadow-sm border overflow-hidden"> <div className="p-4 border-b"><h3 className="font-bold text-gray-700">Daftar Karyawan</h3></div> <table className="w-full text-left text-sm"> <thead className="bg-gray-50 border-b"> <tr> <th className="p-3">Nama/Email</th> <th className="p-3">Divisi</th> <th className="p-3">Password</th> </tr> </thead> <tbody> {users.filter(u => u.role !== 'admin').map(u => ( <tr key={u.id} className="border-b"> <td className="p-3"><div className="font-medium">{u.name}</div><div className="text-xs text-gray-500">{u.email}</div></td> <td className="p-3"><div className="text-xs font-semibold">{u.department}</div><div className="text-xs text-gray-500">{u.location}</div></td> <td className="p-3"><div className="flex items-center gap-2"><span className="font-mono bg-gray-100 px-2 py-1 rounded text-xs">{showPassword[u.id] ? u.password : 'â€¢â€¢â€¢â€¢â€¢â€¢'}</span><button onClick={() => togglePassword(u.id)} className="text-gray-400">{showPassword[u.id] ? <EyeOff size={14}/> : <Eye size={14}/>}</button></div></td> </tr> ))} </tbody> </table> </div> </div> <div> <Card> <h3 className="font-bold text-gray-800 mb-4">Tambah Anggota</h3> <form onSubmit={handleAddUser} className="space-y-3"> <input className="w-full p-2 border rounded text-sm" placeholder="Nama" value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} required /> <input className="w-full p-2 border rounded text-sm" placeholder="Email" value={newUser.email} onChange={e => setNewUser({...newUser, email: e.target.value})} required /> <input className="w-full p-2 border rounded text-sm" placeholder="Divisi" value={newUser.department} onChange={e => setNewUser({...newUser, department: e.target.value})} required /> <input className="w-full p-2 border rounded text-sm" placeholder="Jabatan" value={newUser.position} onChange={e => setNewUser({...newUser, position: e.target.value})} required /> <select className="w-full p-2 border rounded text-sm bg-white" value={newUser.location} onChange={(e) => setNewUser({...newUser, location: e.target.value})} required > <option value="">Pilih Lokasi</option> {LOCATIONS.map(loc => (<option key={loc} value={loc}>{loc}</option>))} </select> <Button className="w-full" variant="success">Simpan</Button> </form> </Card> </div> </div> )}
                {view === 'approvals' && ( <div className="space-y-4"> <div className="bg-white rounded-xl shadow-sm border overflow-hidden overflow-x-auto"> <table className="w-full text-left text-sm"> <thead className="bg-gray-50 border-b"> <tr> <th className="p-4">Nama</th> <th className="p-4">Jenis</th> <th className="p-4">Tanggal</th> <th className="p-4">Alasan</th> <th className="p-4">Aksi</th> </tr> </thead> <tbody> {permits.length === 0 ? <tr><td colSpan="5" className="p-4 text-center">Kosong</td></tr> : permits.sort((a,b)=>new Date(b.dateApplied)-new Date(a.dateApplied)).map(p => ( <tr key={p.id} className="border-b"> <td className="p-4">{p.name}</td> <td className="p-4"><Badge type="info">{p.type}</Badge></td> <td className="p-4">{formatSimpleDate(p.startDate)} - {formatSimpleDate(p.endDate)}</td> <td className="p-4 text-gray-600">{p.reason}</td> <td className="p-4"> {p.status === 'Pending' ? <div className="flex gap-2"><button onClick={()=>handlePermitAction(p.id,'Approved')} className="text-green-600"><CheckCircle/></button><button onClick={()=>handlePermitAction(p.id,'Rejected')} className="text-red-600"><XCircle/></button></div> : <Badge type={p.status==='Approved'?'success':'danger'}>{p.status}</Badge>} </td> </tr> ))} </tbody> </table> </div> </div> )}
                {view === 'reports' && ( <div className="space-y-4"> <div className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center"> <h2>Laporan</h2> <Button icon={Download} onClick={handleExportCSV}>Export</Button> </div> <div className="bg-white rounded-xl shadow-sm border overflow-x-auto"> <table className="w-full text-left text-sm"> <thead className="bg-gray-50 border-b"> <tr> <th className="p-4">Tanggal</th> <th className="p-4">Nama</th> <th className="p-4">Status</th> <th className="p-4">Waktu</th> </tr> </thead> <tbody> {filteredLogs.map(log => ( <tr key={log.id} className="border-b"> <td className="p-4">{new Date(log.timestamp).toLocaleDateString()}</td> <td className="p-4">{log.name}</td> <td className="p-4"><Badge type="success">{log.type}</Badge></td> <td className="p-4">{new Date(log.timestamp).toLocaleTimeString()}</td> </tr> ))} </tbody> </table> </div> </div> )}
                {view === 'announcements' && ( <div className="grid grid-cols-1 md:grid-cols-2 gap-6"> <Card> <h3>Buat Pengumuman</h3> <form onSubmit={(e)=>{e.preventDefault(); handleAddAnnouncement(e.target.content.value); e.target.reset();}}><textarea name="content" className="w-full p-2 border rounded mt-2" placeholder="Isi..."></textarea><Button className="w-full mt-2">Kirim</Button></form> </Card> <div className="space-y-3">{announcements.map(ann => (<div key={ann.id} className="bg-white p-4 rounded shadow-sm border"><h4 className="font-bold">{ann.title}</h4><p className="text-sm text-gray-600">{ann.content}</p></div>))}</div> </div> )}
                {view === 'database' && ( <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> 
                    <Card className="border-l-4 border-yellow-500 md:col-span-3"> 
                        <div className="flex items-center gap-2 mb-2 text-yellow-700"><Cloud size={20}/> <h3 className="font-bold text-lg">Integrasi Google Sheets</h3></div>
                        <p className="text-sm text-gray-600 mb-4">Masukkan URL Web App dari Google Apps Script untuk menyimpan data absensi otomatis ke Spreadsheet Anda.</p>
                        <div className="flex gap-2">
                            <input className="w-full p-2 border rounded text-sm" placeholder="https://script.google.com/macros/s/..." value={newConfig} onChange={(e) => setNewConfig(e.target.value)} />
                            <Button onClick={handleSaveConfig}>Simpan URL</Button>
                        </div>
                    </Card>
                    <Card className="border-l-4 border-blue-500"> <h3 className="font-bold text-lg mb-2">Backup JSON</h3> <Button onClick={handleBackupJSON} className="w-full">Download</Button> </Card> 
                    <Card className="border-l-4 border-green-500"> <h3 className="font-bold text-lg mb-2">Email Laporan</h3> <Button onClick={handleEmailBackup} className="w-full" variant="success">Kirim Email</Button> </Card> 
                    <Card className="border-l-4 border-purple-500"> <h3 className="font-bold text-lg mb-2">Restore JSON</h3> <div className="relative"><input type="file" accept=".json" onChange={handleRestoreJSON} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><Button className="w-full" variant="outline">Upload File</Button></div> </Card> 
                    <Card className="border-l-4 border-red-500 md:col-span-3"> <div className="flex justify-between items-center"> <h3 className="font-bold text-lg text-red-700">Zona Bahaya</h3> <Button onClick={handleResetSystem} variant="danger">Reset Total</Button> </div> </Card> 
                </div> )}
                </div>
            );
        }

        // --- DASHBOARD KARYAWAN ---
        function EmployeeDashboard({ user, logs, announcements, permits, updateData, pushToGoogleSheets }) {
            const [activeTab, setActiveTab] = useState('absen'); 
            const [isCameraOpen, setIsCameraOpen] = useState(false);
            const [location, setLocation] = useState(null);
            const [photo, setPhoto] = useState(null);
            const videoRef = useRef(null);
            const [permitForm, setPermitForm] = useState({ type: 'Sakit', startDate: '', endDate: '', reason: '' });
            const myLogs = logs.filter(l => l.userId === user.id).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const myPermits = permits.filter(p => p.userId === user.id).sort((a,b) => new Date(b.dateApplied) - new Date(a.dateApplied));
            const startCamera = async () => { try { setIsCameraOpen(true); const stream = await navigator.mediaDevices.getUserMedia({ video: true }); if (videoRef.current) videoRef.current.srcObject = stream; } catch (err) { alert("Gagal akses kamera."); } };
            const takePhoto = () => { const video = videoRef.current; const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight; canvas.getContext('2d').drawImage(video, 0, 0); setPhoto(canvas.toDataURL('image/png')); video.srcObject.getTracks().forEach(track => track.stop()); setIsCameraOpen(false); };
            const getLocation = () => { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition( (position) => setLocation({ lat: position.coords.latitude, lng: position.coords.longitude }), () => alert("Gagal lokasi") ); } };
            useEffect(() => { if (activeTab === 'absen') getLocation(); }, [activeTab]);
            const handleSubmitAttendance = (type) => { 
                if (!location) return alert("Menunggu lokasi..."); if (!photo) return alert("Wajib foto!"); 
                const newLog = { id: Date.now(), userId: user.id, name: user.name, type: type, timestamp: new Date().toISOString(), location: `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`, photo: photo, status: 'Hadir' };
                updateData('logs', [newLog, ...logs]); 
                // Push to Google Sheets
                pushToGoogleSheets({ name: user.name, type: type, status: 'Hadir', location: `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`, info: 'Selfie OK' });
                setPhoto(null); alert(`Absen ${type} Berhasil!`); 
            };
            const handleSubmitPermit = (e) => { e.preventDefault(); 
                const newPermit = { id: Date.now(), userId: user.id, name: user.name, type: permitForm.type, startDate: permitForm.startDate, endDate: permitForm.endDate, reason: permitForm.reason, status: 'Pending', dateApplied: new Date().toISOString() };
                updateData('permits', [newPermit, ...permits]); 
                // Push to Google Sheets
                pushToGoogleSheets({ name: user.name, type: 'Pengajuan Izin', status: 'Pending', location: '-', info: `${permitForm.type}: ${permitForm.reason}` });
                setPermitForm({ type: 'Sakit', startDate: '', endDate: '', reason: '' }); alert("Pengajuan berhasil dikirim!"); 
            };

            return (
                <div className="max-w-2xl mx-auto space-y-6">
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-6 text-white shadow-lg">
                    <h2 className="text-2xl font-bold">Halo, {user.name} ðŸ‘‹</h2>
                    <p className="opacity-90 mt-1">{user.position} - {user.department}</p>
                    <p className="text-xs mt-2 bg-white/20 inline-block px-2 py-1 rounded">Lokasi: {user.location || '-'}</p>
                </div>
                <div className="grid grid-cols-3 gap-3">
                    <button onClick={() => setActiveTab('absen')} className={`p-4 rounded-xl flex flex-col items-center gap-2 transition ${activeTab === 'absen' ? 'bg-blue-100 text-blue-700 ring-2 ring-blue-500' : 'bg-white shadow-sm text-gray-600'}`}> <Camera /> <span className="text-xs font-bold">Absen</span> </button>
                    <button onClick={() => setActiveTab('history')} className={`p-4 rounded-xl flex flex-col items-center gap-2 transition ${activeTab === 'history' ? 'bg-blue-100 text-blue-700 ring-2 ring-blue-500' : 'bg-white shadow-sm text-gray-600'}`}> <Clock /> <span className="text-xs font-bold">Riwayat</span> </button>
                    <button onClick={() => setActiveTab('permit')} className={`p-4 rounded-xl flex flex-col items-center gap-2 transition ${activeTab === 'permit' ? 'bg-blue-100 text-blue-700 ring-2 ring-blue-500' : 'bg-white shadow-sm text-gray-600'}`}> <FileText /> <span className="text-xs font-bold">Izin/Cuti</span> </button>
                </div>
                {activeTab === 'absen' && ( <Card className="space-y-6"> <div className="flex items-center justify-between bg-gray-50 p-3 rounded-lg"> <div className="flex items-center gap-3"><MapPin size={16} /> <span className="text-sm font-bold">{location ? 'Lokasi Terkunci' : 'Mencari Lokasi...'}</span></div> {location && <Badge type="success">Akurat</Badge>} </div> <div className="relative bg-black rounded-xl overflow-hidden aspect-[4/3] flex items-center justify-center"> {!isCameraOpen && !photo && <Button onClick={startCamera} variant="outline" className="bg-white/10 text-white border-white/20">Buka Kamera</Button>} {isCameraOpen && <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover"></video>} {photo && <img src={photo} className="w-full h-full object-cover" />} {isCameraOpen && <div className="absolute bottom-4 left-0 right-0 flex justify-center"><button onClick={takePhoto} className="w-16 h-16 bg-white rounded-full border-4 flex items-center justify-center"><div className="w-12 h-12 bg-red-500 rounded-full"></div></button></div>} </div> {photo && <div className="flex flex-col gap-3"> <Button variant="success" onClick={() => handleSubmitAttendance('Masuk')}>Absen Masuk</Button> <Button variant="warning" onClick={() => handleSubmitAttendance('Istirahat')}>Absen Istirahat</Button> <Button variant="danger" onClick={() => handleSubmitAttendance('Pulang')}>Absen Pulang</Button> </div>} {photo && <Button variant="outline" className="w-full" onClick={() => setPhoto(null)}>Foto Ulang</Button>} </Card> )}
                {activeTab === 'permit' && ( <div className="space-y-6"> <Card> <h3 className="font-bold text-gray-800 mb-4">Buat Pengajuan Baru</h3> <form onSubmit={handleSubmitPermit} className="space-y-3"> <div> <label className="text-xs font-bold text-gray-500">Jenis Izin</label> <select className="w-full p-2 border rounded-lg mt-1" value={permitForm.type} onChange={e => setPermitForm({...permitForm, type: e.target.value})}> <option value="Sakit">Sakit</option> <option value="Izin">Izin (Keperluan Pribadi)</option> <option value="Cuti Tahunan">Cuti Tahunan</option> <option value="Cuti Melahirkan">Cuti Melahirkan</option> <option value="Dinas Luar">Dinas Luar</option> </select> </div> <div className="grid grid-cols-2 gap-2"> <div> <label className="text-xs font-bold text-gray-500">Mulai</label> <input type="date" required className="w-full p-2 border rounded-lg mt-1" value={permitForm.startDate} onChange={e => setPermitForm({...permitForm, startDate: e.target.value})} /> </div> <div> <label className="text-xs font-bold text-gray-500">Sampai</label> <input type="date" required className="w-full p-2 border rounded-lg mt-1" value={permitForm.endDate} onChange={e => setPermitForm({...permitForm, endDate: e.target.value})} /> </div> </div> <div> <label className="text-xs font-bold text-gray-500">Alasan / Keterangan</label> <textarea required className="w-full p-2 border rounded-lg mt-1 h-20" placeholder="Jelaskan alasan pengajuan..." value={permitForm.reason} onChange={e => setPermitForm({...permitForm, reason: e.target.value})}></textarea> </div> <Button className="w-full">Kirim Pengajuan</Button> </form> </Card> </div> )}
                {activeTab === 'history' && ( <div className="space-y-4"> <h3 className="font-bold text-gray-700">Riwayat Absensi</h3> {myLogs.length === 0 ? <div className="text-center py-8 text-gray-500 bg-white rounded-xl border border-dashed">Belum ada riwayat.</div> : myLogs.map(log => ( <div key={log.id} className="bg-white p-4 rounded-xl shadow-sm border flex items-center gap-4"> <div className={`w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${log.type === 'Masuk' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}> {log.type === 'Masuk' ? <LogOut className="rotate-180" size={20} /> : <LogOut size={20} />} </div> <div className="flex-1"> <h4 className="font-bold text-gray-800">{log.type}</h4> <p className="text-xs text-gray-500">{formatDate(log.timestamp)}</p> </div> {log.photo && <img src={log.photo} className="w-12 h-12 rounded-lg object-cover border" />} </div> )) } </div> )}
                <canvas ref={canvasRef} className="hidden"></canvas>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
